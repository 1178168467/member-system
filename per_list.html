<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>权限分配</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* 适配原有系统样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", Arial, sans-serif;
    }
    .header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .nav {
      background-color: #34495e;
      padding: 0 20px;
    }
    .nav ul {
      list-style: none;
      display: flex;
    }
    .nav ul li a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 15px 20px;
      transition: background-color 0.3s;
    }
    .nav ul li a:hover, .nav ul li a.active {
      background-color: #1abc9c;
    }
    .content {
      padding: 25px 20px;
      background-color: #ecf0f1;
      min-height: calc(100vh - 120px);
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 25px;
      margin-bottom: 20px;
    }
    .card h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .form-label {
      color: #34495e;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s;
    }
    .btn-primary { background-color: #3498db; }
    .btn-primary:hover { background-color: #2980b9; }
    .btn-primary:disabled { background-color: #95a5a6; cursor: not-allowed; }
    .btn-secondary { background-color: #95a5a6; }
    .btn-secondary:hover { background-color: #7f8c8d; }
    .form-select, .form-check-input {
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .form-check {
      margin-bottom: 10px;
    }
    .back-btn {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <!-- 头部导航（和系统其他页面统一） -->
  <div class="header">
    <div class="title">会员管理系统 - 权限分配</div>
    <div class="user-info">
      <span>当前登录：{{ session.username }}</span>
      <a href="/logout" style="color: white; margin-left: 15px; text-decoration: none;">退出登录</a>
    </div>
  </div>

  <div class="nav">
    <ul>
      <li><a href="/">工作台</a></li>
      <li><a href="/member">会员管理</a></li>
      <li><a href="/consume">消费收银</a></li>
      <li><a href="/recharge">充值管理</a></li>
      <li><a href="/points">积分管理</a></li>
      <li><a href="/report">统计报表</a></li>
      <li><a href="/setting">系统设置</a></li>
    </ul>
  </div>

  <!-- 主要内容 -->
  <div class="content">
    <a href="/setting" class="btn btn-secondary back-btn">
      <i class="bi bi-arrow-left"></i> 返回系统设置
    </a>

    <div class="card">
      <h3>操作员权限分配</h3>
      
      <!-- 选择操作员 -->
      <div class="mb-4">
        <label class="form-label">选择操作员</label>
        <select id="adminSelect" class="form-select" onchange="loadAdminPerms(this.value)">
          {% for admin in admins %}
          <option value="{{ admin.id }}">{{ admin.username }} ({{ admin.role }})</option>
          {% endfor %}
        </select>
      </div>

      <!-- 权限勾选框 -->
      <div class="mb-4">
        <label class="form-label">分配权限</label>
        <div class="row">
          {% for perm in perms %}
          <div class="col-md-6">
            <div class="form-check">
              <input 
                class="form-check-input permCheck" 
                type="checkbox" 
                id="perm-{{ perm.id }}"
                value="{{ perm.perm_name }}"
              >
              <label class="form-check-label" for="perm-{{ perm.id }}">
                {{ perm.perm_desc }}
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- 保存按钮 -->
      <button id="saveBtn" onclick="savePerm()" class="btn btn-primary">
        <i class="bi bi-save"></i> 保存权限
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // 1. 缓存所有操作员的权限（从后端模板变量转换）
    const allAdminPerms = {
      {% for admin_id, perms in perm_dict.items() %}
        {{ admin_id }}: {{ perms | tojson }},
      {% endfor %}
    };

    // 2. 页面加载时初始化第一个操作员的权限
    window.onload = () => {
      const firstAdminId = document.getElementById('adminSelect').value;
      loadAdminPerms(firstAdminId);
    };

    // 3. 切换操作员时加载对应权限
    function loadAdminPerms(adminId) {
      // 获取当前操作员的权限列表（无则为空数组）
      const targetPerms = allAdminPerms[adminId] || [];
      // 遍历所有权限勾选框，更新状态
      document.querySelectorAll('.permCheck').forEach(el => {
        el.checked = targetPerms.includes(el.value);
      });
    }

    // 4. 保存权限（完整优化版）
    function savePerm() {
      const adminId = document.getElementById('adminSelect').value;
      const saveBtn = document.getElementById('saveBtn');
      const permChecks = document.querySelectorAll('.permCheck');
      
      // 收集勾选的权限
      const permNames = [];
      permChecks.forEach(el => {
        if (el.checked) permNames.push(el.value);
      });

      // 空权限校验
      if (permNames.length === 0) {
        alert('⚠️ 请至少勾选一项权限！');
        return;
      }

      // 禁用按钮，防止重复点击
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';

      // 构造请求参数（规范的urlencoded格式）
      const params = new URLSearchParams();
      params.append('admin_id', adminId);
      permNames.forEach(perm => {
        params.append('perm_names[]', perm);
      });

      // 发送请求
      axios.post('/setting/assign_perm', params)
        .then(res => {
          if (res.data.success) {
            alert('✅ ' + res.data.msg);
            // 更新缓存的权限，避免页面刷新前显示错误
            allAdminPerms[adminId] = permNames;
          } else {
            alert('❌ ' + res.data.msg);
          }
        })
        .catch(err => {
          // 详细的错误提示
          console.error('权限保存失败：', err);
          const errMsg = err.response?.data?.msg || '网络错误/服务器异常';
          alert(`❌ 权限保存失败：${errMsg}`);
        })
        .finally(() => {
          // 恢复按钮状态
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-save"></i> 保存权限';
        });
    }
  </script>
</body>
</html>