<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>权限分配</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h2>操作员权限分配</h2>
    <!-- 返回按钮 -->
    <a href="/setting" class="btn btn-secondary mb-3">← 返回系统设置</a>
    
    <div class="card">
      <div class="card-body">
        <!-- 选择操作员 -->
        <div class="mb-4">
          <label class="form-label">选择操作员</label>
          <select id="adminSelect" class="form-select">
            {% for admin in admins %}
            <option value="{{ admin.id }}">{{ admin.username }} ({{ admin.role }})</option>
            {% endfor %}
          </select>
        </div>

        <!-- 权限勾选框 -->
        <div class="mb-4">
          <label class="form-label">分配权限</label>
          <div class="row">
            {% for perm in perms %}
            <div class="col-md-6 mb-2">
              <div class="form-check">
                <input 
                  class="form-check-input permCheck" 
                  type="checkbox" 
                  value="{{ perm.perm_name }}"
                  {% if admin.id in perm_dict and perm.perm_name in perm_dict[admin.id] %}checked{% endif %}
                >
                <label class="form-check-label">{{ perm.perm_desc }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- 保存按钮 -->
        <button onclick="savePerm()" class="btn btn-primary">保存权限</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // 保存权限
    function savePerm() {
      const adminId = document.getElementById('adminSelect').value;
      const permNames = [];
      // 收集勾选的权限
      document.querySelectorAll('.permCheck:checked').forEach(el => {
        permNames.push(el.value);
      });
      // 提交到后端
      axios.post('/setting/assign_perm', {
        admin_id: adminId,
        perm_names: permNames
      }, {
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        transformRequest: (data) => {
          // 处理多选参数格式
          let ret = '';
          for (let k in data) {
            if (Array.isArray(data[k])) {
              data[k].forEach(v => {
                ret += `${encodeURIComponent(k)}[]=${encodeURIComponent(v)}&`;
              });
            } else {
              ret += `${encodeURIComponent(k)}=${encodeURIComponent(data[k])}&`;
            }
          }
          return ret.slice(0, -1);
        }
      }).then(res => {
        alert(res.data.msg);
      }).catch(err => {
        alert('权限保存失败');
      });
    }
  </script>
</body>
</html>